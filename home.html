<!DOCTYPE html>
<html lang="th" data-theme="light">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>CRM-3RN</title>
  <!-- Load config before main script -->
  <script src="config.js"></script>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- DaisyUI CDN (includes Tailwind CSS) -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@latest/dist/full.css" rel="stylesheet" type="text/css" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .hidden { display: none !important; }
    @keyframes pulseCustom { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.02); opacity: 0.6; } }
    .pulse-custom { animation: pulseCustom 1.2s ease-in-out infinite; }
    @keyframes pulse-opacity {  0%, 100% { opacity: 0.5;  } 50% { opacity: 1;  } }
    .loading-card-animation { animation: pulse-opacity 1.5s infinite ease-in-out; }
    .glass-white{
        background: rgba(255, 255, 255, 0.15);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(8.1px);
        -webkit-backdrop-filter: blur(8.1px);
        border: 1px solid rgba(255, 255, 255, 0.3);}
    .glass-black{
        background: rgba(0, 0, 0, 0.29);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(8.1px);
        -webkit-backdrop-filter: blur(8.1px);
        border: 1px solid rgba(0, 0, 0, 0.3);}
  </style>
</head>
<body class="bg-gradient-to-b from-neutral via-white to-white min-h-screen relative bg-fixed p-6">
  <div class="flex justify-between items-center mb-6">
    <h2 id="pageTitle" class="text-xl font-bold text-white">กำลังโหลด...</h2>
    <div class="glass-white rounded-full flex items-center p-1 space-x-2">
      <div class="w-8 h-8 bg-yellow-400 p-1 rounded-full pulse-custom">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" color="#ffffff" fill="none">
          <path
            d="M22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12Z"
            stroke="currentColor" stroke-width="1.5"></path>
          <path
            d="M9 12H13.2M9 12V9.2963C9 8.82489 9 8.58919 9.14645 8.44274C9.29289 8.2963 9.5286 8.2963 10 8.2963H13.2C14.1941 8.2963 15 9.1254 15 10.1481C15 11.1709 14.1941 12 13.2 12M9 12V14.7037C9 15.1751 9 15.4108 9.14645 15.5572C9.29289 15.7037 9.5286 15.7037 10 15.7037H13.2C14.1941 15.7037 15 14.8746 15 13.8518C15 12.8291 14.1941 12 13.2 12M10.4938 8.2963V7M10.4938 17V15.7037M12.8982 8.2963V7M12.8982 17V15.7037"
            stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>
        </svg>
      </div>
      <!-- ปรับปรุงตรงนี้: เพิ่ม div สำหรับ level และ progress bar -->
      <div class="flex flex-col items-end space-y-0.5">
        <div id="pointVal" class="font-bold text-black text-lg">0</div> 
        <div class="flex items-center space-x-1">
          <span id="levelTextDisplay" class="font-bold text-black text-sm">กำลังโหลด...</span>
          <span id="levelBadge" class="badge badge-sm"></span>
          <span id="customTagBadge" class="badge badge-sm badge-neutral"></span> <!-- NEW: Tag element for custom user tag -->
        </div>
        <progress id="progressBar" class="progress progress-warning w-24 sm:w-32" value="0" max="100"></progress>
        <span id="pointsToNextLevel" class="text-xs text-gray-700 hidden sm:block"></span>
      </div>
      <img id="lineDisplayPicture" class="mask mask-circle w-10 h-10 rounded-full object-cover border-2 border-black" src="https://img.daisyui.com/images/stock/photo-1567653418876-5bb0e566e1c2.webp" />
    </div>
  </div>
  <div id="app">
    <div class="text-center text-gray-100 py-8">กำลังโหลดเนื้อหา...</div>
  </div>
  <dialog id="customAlertDialog" class="modal">
    <div class="modal-box text-center">
      <h3 id="customAlertTitle" class="font-bold text-lg mb-3"></h3>
      <p id="customAlertMessage" class="py-4 whitespace-pre-line"></p>
      <div class="modal-action justify-center">
        <button id="customAlertButton" class="btn btn-neutral w-full">ตกลง</button>
      </div>
    </div>
  </dialog>
  <dialog id="customConfirmDialog" class="modal">
    <div class="modal-box text-center">
      <h3 id="customConfirmTitle" class="font-bold text-lg mb-3"></h3>
      <p id="customConfirmMessage" class="py-4"></p>
      <div class="modal-action justify-around">
        <button id="customConfirmCancelButton" class="btn btn-outline btn-neutral">ยกเลิก</button>
        <button id="customConfirmConfirmButton" class="btn btn-neutral">ยืนยัน</button>
      </div>
    </div>
  </dialog>

  <!-- Template: Dashboard (Main Menu) -->
  <template id="view-dashboard">
    <div class="glass-white rounded p-4 grid grid-cols-3 gap-3 text-center text-sm font-medium mb-6">
      <a href="#event"
        class="bg-white text-black p-3 rounded flex flex-col items-center justify-center space-y-1 transform hover:scale-105 transition-transform">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
        </svg>
        <span>กิจกรรม</span>
      </a>
      <a href="#warehouse"
        class="bg-white text-black p-3 rounded flex flex-col items-center justify-center space-y-1 transform hover:scale-105 transition-transform">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
        </svg>
        <span>คลัง</span>
      </a>
      <a href="#addpoint"
        class="bg-white text-black p-3 rounded flex flex-col items-center justify-center space-y-1 transform hover:scale-105 transition-transform">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-6 w-6"  fill="none">
          <path
            d="M2.5 8.18677C2.60406 6.08705 2.91537 4.77792 3.84664 3.84664C4.77792 2.91537 6.08705 2.60406 8.18677 2.5M21.5 8.18677C21.3959 6.08705 21.0846 4.77792 20.1534 3.84664C19.2221 2.91537 17.9129 2.60406 15.8132 2.5M15.8132 21.5C17.9129 21.3959 19.2221 21.0846 20.1534 20.1534C21.0846 19.2221 21.3959 17.9129 21.5 15.8132M8.18676 21.5C6.08705 21.3959 4.77792 21.0846 3.84664 20.1534C2.91537 19.2221 2.60406 17.9129 2.5 15.8132"
            stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>
          <path d="M2.49986 12H21.4999" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>
          <path
            d="M6 12C6 8.68629 8.68629 6 12 6C12 7.65685 13.3431 9 15 9C15.6755 9 16.2989 8.77672 16.8004 8.39993C17.5536 9.40273 18 10.6492 18 12M17.1973 15C16.1599 16.7934 14.2208 18 12 18C9.77915 18 7.84012 16.7934 6.80269 15"
            stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
        </svg>
        <span>สแกนรับ</span>
      </a>
      <a href="#transfer"
        class="bg-white text-black p-3 rounded flex flex-col items-center justify-center space-y-1 transform hover:scale-105 transition-transform">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
        </svg>
        <span>โอนพ้อย</span>
      </a>
      <a href="#redeem"
        class="bg-white text-black p-3 rounded flex flex-col items-center justify-center space-y-1 transform hover:scale-105 transition-transform">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" />
        </svg>
        <span>แลกพ้อย</span>
      </a>
      <a href="#profile"
        class="bg-white text-black p-3 rounded flex flex-col items-center justify-center space-y-1 transform hover:scale-105 transition-transform">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
        <span>บัญชี</span>
      </a>
    </div>

    <!-- Check-in Section -->
    <div id="checkinBox" class="flex items-center justify-between mb-8 hidden">
      <div class="bg-gray-100 rounded-full px-4 py-2 flex items-center space-x-2 text-gray-700">
        <span class="text-sm">วันที่</span>
        <span id="todayDate" class="font-bold text-md">00</span>
      </div>
      <div class="bg-yellow-400 rounded-full w-10 h-10 flex items-center justify-center text-white font-bold text-sm">
        +1
      </div>
      <button id="checkinBtn" class="btn btn-neutral btn-sm"> 
        เช็คอิน
      </button>
    </div>

    <!-- History Section -->
    <div>
      <div class="flex justify-between items-center mb-4">
        <div class="font-bold text-lg">รายการล่าสุด</div>
        <div class="text-xs text-gray-400 font-medium">POINT</div>
      </div>
      <ul id="historyList" class="space-y-4">
        <!-- skeleton loader -->
      </ul>
    </div>
  </template>

  <!-- Template: Event List -->
  <template id="view-event">
    <!-- Event List -->
    <div id="eventList" class="space-y-3">
      <div class="bg-white rounded p-4 flex justify-between items-center shadow-sm animate-pulse">
        <div class="space-y-2 w-3/4">
          <div class="h-4 bg-gray-200 rounded w-1/2"></div>
          <div class="h-3 bg-gray-200 rounded w-2/3"></div>
        </div>
        <div class="h-6 w-20 bg-gray-200 rounded-full"></div>
      </div>
    </div>
  </template>

  <!-- Template: Event Detail -->
  <template id="view-event-detail">
    <div id="cardWrapper">
      <div id="cardSkeleton" class="bg-white p-6 rounded shadow-md mb-6 animate-pulse">
        <div class="h-6 bg-gray-200 rounded w-1/3 mb-4"></div>
        <div class="h-4 bg-gray-200 rounded w-1/4 mb-2"></div>
        <div class="h-3 bg-gray-200 rounded w-full mb-6"></div>
        <div class="h-12 bg-gray-200 rounded-full w-full"></div>
      </div>
      <div id="card" class="bg-white p-6 rounded shadow-md text-gray-800 mb-6 hidden">
        <div class="flex justify-between items-start mb-3">
          <div class="font-bold text-lg" id="eventDetailTitle">–</div>
          <div class="bg-yellow-400 text-black font-bold text-md px-3 py-1 rounded-full" id="eventPoint">0+</div>
        </div>
        <div class="text-sm text-gray-700 mb-6 leading-relaxed" id="eventDetailDesc">...</div>
        <button id="joinBtn" class="btn btn-neutral w-full"> 
          เข้าร่วม
        </button>
      </div>
    </div>
  </template>

  <!-- Template: Profile -->
  <template id="view-profile">
    <div class="space-y-4">
      <div class="glass-white p-6 rounded-lg text-center shadow-md">
        <img id="profileDisplayPicture" class="mask mask-circle w-24 h-24 mx-auto mb-4 rounded-full object-cover border-4 border-black" src="https://img.daisyui.com/images/stock/photo-1567653418876-5bb0e566e1c2.webp" alt="รูปโปรไฟล์" />
        <div class="text-2xl font-bold mb-2" id="profileDisplayName">กำลังโหลด...</div>
        <div class="flex items-center justify-center space-x-2 mb-2"> 
          <span class="text-lg font-bold" id="profileLevelTextDisplay"></span> 
          <span id="profileLevelBadge" class="badge badge-lg"></span>
          <span id="profileCustomTagBadge" class="badge badge-lg badge-neutral"></span> <!-- NEW: Larger Tag element for profile -->
        </div>
        <progress id="profileProgressBar" class="progress progress-warning w-full" value="0" max="100"></progress>
        <div id="profilePointsToNextLevel" class="text-sm text-gray-700 mt-1"></div>
        <div class="font-bold text-xl mt-4">รวมพ้อยต์: <span id="profileTotalPoints">0</span></div>
      </div>

      <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">LINE ID</label>
          <input id="profileLineId" readonly class="input input-bordered input-neutral w-full cursor-not-allowed text-gray-500" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">ชื่อ</label>
          <input id="profileName" class="input input-bordered input-neutral w-full" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">เบอร์โทรศัพท์</label>
          <input id="profilePhone" class="input input-bordered input-neutral w-full" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">อีเมล</label>
          <input id="profileEmail" class="input input-bordered input-neutral w-full" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">ที่อยู่</label>
          <input id="profileAddress" class="input input-bordered input-neutral w-full" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">หมายเหตุ</label>
          <input id="profileNote" class="input input-bordered input-neutral w-full" />
        </div>
        <button id="updateProfileBtn" class="btn btn-neutral w-full">
          อัปเดตข้อมูล
        </button>
      </div>
    </div>
  </template>


  <!-- Template: Redeem -->
  <template id="view-redeem">
    <div class="p-0">
      <ul id="redeemList" class="grid grid-cols-2 gap-4">
      </ul>
    </div>
  </template>

  <!-- Template: Transfer -->
  <template id="view-transfer">
    <!-- Form -->
    <div class="space-y-4 mb-6">
      <input id="transferTo" placeholder="LINE ID เพื่อน / เบอร์โทรปลายทาง" type="text"
        class="input input-bordered input-neutral w-full"> 
      <input id="transferAmount" placeholder="จำนวนพ้อยที่ต้องการโอน" type="number"
        class="input input-bordered input-neutral w-full">
      <button id="transferBtn" class="btn btn-neutral w-full">
        โอนพ้อย
      </button>
    </div>
  </template>

  <!-- Template: Warehouse -->
  <template id="view-warehouse">
    <ul id="warehouseList" class="space-y-3">
      <li class="bg-white rounded p-4 shadow-sm loading-card-animation flex justify-between items-center">
        <div class="space-y-2 flex-1">
          <div class="h-4 bg-gray-200 rounded w-1/2"></div>
          <div class="h-3 bg-gray-200 rounded w-1/3"></div>
        </div>
        <div class="h-6 w-12 bg-gray-200 rounded-full"></div>
      </li>
    </ul>
  </template>

  <!-- Template: Add Points (Scan/Manual Code) -->
  <template id="view-addpoint">
    <div id="scanContainer" class="space-y-4 mb-6">
      <button id="scanBtn" class="btn btn-neutral w-full"> 
        สแกน QR Code
      </button>
      <div class="flex space-x-2">
        <input id="manualCode" type="text" placeholder="กรอกโค้ดที่นี่"
          class="input input-bordered input-neutral flex-1"> 
        <button id="enterBtn" class="btn btn-neutral"> 
          รับโค้ด
        </button>
      </div>
    </div>
  </template>


  <script>
    // Global LIFF status and user info
    let liffInitialized = false;
    const userState = {
      profile: null, // LIFF profile (userId, displayName, pictureUrl)
      lineId: "",
      points: 0,
      pointsChanged: false, // Flag to indicate if points have changed since last render
      level: "Member", // เพิ่ม field สำหรับเก็บระดับ
      customTag: ""    // NEW: เพิ่ม field สำหรับเก็บ custom tag
    };

    // Global Data Cache for frequently accessed data
    const dataCache = {
      events: null, // For getEvents (initEvent)
      redeemItems: null, // For getItems (initRedeem)
      eventDetails: {}, // For initEventDetail, stores {eventId: eventData}
      userProfileFull: null, // For getUserInfo full CRM profile (initProfile)
      history: null, // For getHistory (dashboard, event detail, warehouse, addpoint)
    };

    // Common Alert & Confirm Dialogs (references to elements are global now)
    const alertDialog = document.getElementById('customAlertDialog');
    const alertT = document.getElementById('customAlertTitle');
    const alertM = document.getElementById('customAlertMessage');
    const alertBtn = document.getElementById('customAlertButton');

    const confirmDialog = document.getElementById('customConfirmDialog');
    const confT = document.getElementById('customConfirmTitle');
    const confM = document.getElementById('customConfirmMessage');
    const okBtn = document.getElementById('customConfirmConfirmButton');
    const noBtn = document.getElementById('customConfirmCancelButton');

    // Global Header Elements (MOVED HERE)
    const pageTitleEl = document.getElementById('pageTitle');
    const pointValEl = document.getElementById('pointVal');
    const dpEl = document.getElementById('lineDisplayPicture');

    // Header Elements สำหรับ Level, Progress Bar, และ Custom Tag
    const levelTextDisplayEl = document.getElementById('levelTextDisplay');
    const levelBadgeEl = document.getElementById('levelBadge');
    const customTagBadgeEl = document.getElementById('customTagBadge'); // NEW: for the custom tag badge
    const progressBarEl = document.getElementById('progressBar');
    const pointsToNextLevelEl = document.getElementById('pointsToNextLevel');

    // Define styles for each level (for level badges)
    const LEVEL_STYLES = {
      'Member': { text: 'Member', class: 'badge-info badge-outline' },
      'VIP': { text: 'VIP', class: 'badge-primary badge-outline' },
      'Super': { text: 'Super', class: 'badge-success badge-outline' }
    };

    // NEW: Define styles for custom tags (optional, can be expanded)
    const CUSTOM_TAG_STYLES = {
      'newuser': { class: 'badge-warning', text: 'New User' }, // Example for specific tag
      'ceo': { class: 'badge-accent', text: 'CEO' },
      'admin': { class: 'badge-error', text: 'Admin' },
      // Add more custom tags here if needed
      'default': { class: 'badge-neutral', text: '' } // Default style if tag not found or empty
    };

    // --- Common UI Functions ---
    function showAlert(title, message, cb) {
      alertT.textContent = title;
      alertM.textContent = message;
      alertDialog.showModal(); // Show the modal

      const hide = () => {
        alertDialog.close(); // Close the modal
        alertBtn.removeEventListener('click', hide);
        cb && cb();
      };
      alertBtn.addEventListener('click', hide);
    }

    function showConfirm(title, message) {
      return new Promise(res => {
        confT.textContent = title;
        confM.textContent = message;
        confirmDialog.showModal(); // Show the modal

        const onOk = () => { cleanup(); res(true); };
        const onNo = () => { cleanup(); res(false); };

        function cleanup() {
          confirmDialog.close(); // Close the modal
          okBtn.removeEventListener('click', onOk);
          noBtn.removeEventListener('click', onNo);
        }
        okBtn.addEventListener('click', onOk);
        noBtn.addEventListener('click', onNo);
      });
    }

    // --- LIFF Initialization & Initial Data Fetch ---
    async function ensureLIFFAndFetchInitialData() {
      if (!liffInitialized) {
        try {
            await liff.init({ liffId: CONFIG.LIFF_ID });
            liffInitialized = true;
        } catch (e) {
            console.error("LIFF initialization failed", e);
            showAlert("ข้อผิดพลาด", "ไม่สามารถเริ่มต้น LIFF ได้ กรุณาลองใหม่ภายหลัง");
            return false;
        }
      }

      if (!liff.isLoggedIn()) {
        liff.login();
        return false; // Stop execution if not logged in, LIFF will handle redirect
      }

      // Fetch LIFF profile if not already set (should only happen once)
      if (!userState.profile) {
          userState.profile = await liff.getProfile();
          userState.lineId = userState.profile.userId;

          // Update global header with display picture
          dpEl.src = userState.profile.pictureUrl || 'https://upload.wikimedia.org/wikipedia/commons/thumb/1/18/Line-icon.svg/1200px-Line-icon.svg.png';
          dpEl.alt = `รูปโปรไฟล์ของ ${userState.profile.displayName}`;
      }
      
      pointValEl.textContent = '0'; // Show loading state for points

      try {
        // Fetch user info (points, registration status, level, customTag) AND history concurrently
        console.log("Fetching initial user info and history concurrently...");
        const [userRes, histRes] = await Promise.all([
          fetch(`${CONFIG.GAS_URL}?action=getUserInfo&lineId=${userState.lineId}`),
          fetch(`${CONFIG.GAS_URL}?action=getHistory&lineId=${userState.lineId}`)
        ]);
        const userData = await userRes.json();
        const historyData = await histRes.json();

        if (!userData || !userData.name || userData.isRegistered === false) { 
          console.log("User not registered. Redirecting to register.html");
          window.location.href = 'register.html';
          return false;
        }

        userState.points = parseInt(userData.point || 0, 10);
        userState.level = userData.level || 'Member';
        userState.customTag = userData.customTag || ''; // NEW: Get custom tag

        updatePointsInHeader(userState.points); // อัปเดต UI ด้วยคะแนน, ระดับ, และ Tag
        dataCache.history = historyData;

      } catch (error) {
        console.error("Failed to fetch initial user points or history:", error);
        pointValEl.textContent = 'N/A';
        showAlert("ข้อผิดพลาด", "ไม่สามารถโหลดข้อมูลผู้ใช้ได้ กรุณาลองใหม่");
        return false;
      }
      return true;
    }

    // --- Router Setup ---
    const routes = {
      '#dashboard': { title: 'CRM-3RN', tpl: 'view-dashboard', init: initDashboard },
      '#event': { title: 'กิจกรรม', tpl: 'view-event', init: initEvent },
      '#event-detail': { title: 'รายละเอียดกิจกรรม', tpl: 'view-event-detail', init: initEventDetail },
      '#profile': { title: 'โปรไฟล์ของคุณ', tpl: 'view-profile', init: initProfile },
      '#redeem': { title: 'ร้านค้าแลกของรางวัล', tpl: 'view-redeem', init: initRedeem },
      '#transfer': { title: 'โอนพ้อยให้เพื่อน', tpl: 'view-transfer', init: initTransfer },
      '#warehouse': { title: 'คลังของรางวัล', tpl: 'view-warehouse', init: initWarehouse },
      '#addpoint': { title: 'โค้ดเพื่อรับรางวัล', tpl: 'view-addpoint', init: initAddpoint },
      '': { title: 'CRM-3RN', tpl: 'view-dashboard', init: initDashboard }
    };

    async function router() {
      const hash = window.location.hash.split('?')[0] || '';
      const route = routes[hash] || routes[''];
      const appDiv = document.getElementById('app');

      pageTitleEl.textContent = route.title;

      appDiv.innerHTML = '';
      const template = document.getElementById(route.tpl);
      if (template) {
        appDiv.appendChild(template.content.cloneNode(true));
      } else {
        appDiv.innerHTML = `<p class="text-center text-red-500 py-8">เกิดข้อผิดพลาด: ไม่พบเทมเพลตสำหรับ ${hash}</p>`;
        console.error(`Template ${route.tpl} not found.`);
        return;
      }

      try {
        await route.init();
      } catch (error) {
        console.error(`Error initializing view ${route.tpl}:`, error);
        showAlert('เกิดข้อผิดพลาด', 'ไม่สามารถโหลดข้อมูลหน้านี้ได้ กรุณาลองใหม่อีกครั้ง');
      }
    }

    // --- Common Helper Functions ---
    function generateListSkeleton(count) { /* ... same as before ... */ return ``; }
    function generateCardSkeleton(count) { /* ... same as before ... */ return ``; }

    function calculateLevelAndProgress(currentPoints) { /* ... same as before ... */ }

    /**
     * Helper to set badge text and classes.
     * @param {HTMLElement} badgeElement - The DOM element for the badge.
     * @param {string} text - The text to display in the badge.
     * @param {string} className - DaisyUI class names for the badge (e.g., 'badge badge-sm badge-info').
     */
    function setBadgeContent(badgeElement, text, className) {
        if (!badgeElement) return;
        badgeElement.textContent = text;
        badgeElement.className = className;
        if (text) {
            badgeElement.classList.remove('hidden');
        } else {
            badgeElement.classList.add('hidden'); // Hide if no text
        }
    }

    /**
     * Updates the global header with user points, level, and custom tag.
     * This function should be called after any action that changes points or initial load.
     * @param {number} newPoints - The new point value to display.
     */
    function updatePointsInHeader(newPoints) {
      userState.points = newPoints;
      pointValEl.textContent = userState.points;
      userState.pointsChanged = true;

      const { level, progressValue, pointsToNext, nextLevelName } = calculateLevelAndProgress(newPoints);
      userState.level = level; // อัปเดต userState.level ด้วย

      // Update level text and badge in header
      if (levelTextDisplayEl) {
        levelTextDisplayEl.textContent = LEVEL_STYLES[level] ? LEVEL_STYLES[level].text : level;
      }
      setBadgeContent(levelBadgeEl, LEVEL_STYLES[level] ? LEVEL_STYLES[level].text : level, `badge badge-sm ${LEVEL_STYLES[level] ? LEVEL_STYLES[level].class : ''}`);
      
      // NEW: Update custom tag badge in header
      const customTagInfo = CUSTOM_TAG_STYLES[userState.customTag.toLowerCase()] || CUSTOM_TAG_STYLES['default'];
      const tagText = userState.customTag || customTagInfo.text; // Use actual tag if present, else default text
      setBadgeContent(customTagBadgeEl, tagText, `badge badge-sm ${customTagInfo.class}`);
      if (!userState.customTag) customTagBadgeEl.classList.add('hidden'); // Ensure hidden if no tag

      if (progressBarEl) progressBarEl.value = progressValue;
      if (pointsToNextLevelEl) {
        if (nextLevelName) {
          pointsToNextLevelEl.textContent = `อีก ${pointsToNext} พ้อยต์ สู่ระดับ ${nextLevelName}`;
        } else {
          pointsToNextLevelEl.textContent = `คุณอยู่ในระดับสูงสุดแล้ว!`;
        }
      }
    }

    function renderHistoryList(historyDataToRender) { /* ... same as before ... */ }
    async function getFreshOrCachedHistory() { /* ... same as before ... */ }


    // --------- Init functions for each view ---------

    async function initDashboard() {
      // ... (no changes needed here, as updatePointsInHeader handles the UI)
      const historyListEl = document.getElementById('historyList');
      const checkinBox = document.getElementById('checkinBox');
      const todayDateEl = document.getElementById('todayDate');
      const checkinBtn = document.getElementById('checkinBtn');

      if (dataCache.history && !userState.pointsChanged) {
        renderHistoryList(dataCache.history);
      } else {
        if (historyListEl) historyListEl.innerHTML = generateListSkeleton(5);
      }

      try {
        const checkRes = await fetch(`${CONFIG.GAS_URL}?action=checkinStatus&lineId=${userState.lineId}`);
        const checkData = await checkRes.json();
        const history = await getFreshOrCachedHistory(); 
        renderHistoryList(history);

        if (checkinBox && todayDateEl && checkinBtn) {
          if (!checkData.checkedInToday) {
            checkinBox.classList.remove('hidden');
            todayDateEl.textContent = new Date().getDate().toString().padStart(2, "0");
            checkinBtn.onclick = async () => {
              checkinBtn.disabled = true;
              try {
                const res = await fetch(CONFIG.GAS_URL, {
                  method: 'POST',
                  body: JSON.stringify({ action: "dailyCheckin", lineId: userState.lineId })
                });
                const text = await res.text();
                showAlert('เช็คอินสำเร็จ', text, async () => {
                  if (text.includes("สำเร็จ")) {
                    const userRes = await fetch(`${CONFIG.GAS_URL}?action=getUserInfo&lineId=${userState.lineId}`);
                    const userData = await userRes.json();
                    if (userData && !userData.error) {
                        updatePointsInHeader(parseInt(userData.point || 0, 10));
                    }
                    userState.pointsChanged = true;
                    initDashboard(); 
                  }
                });
              } catch (e) {
                console.error("Check-in failed:", e);
                showAlert('ข้อผิดพลาด', 'ไม่สามารถเช็คอินได้ กรุณาลองใหม่');
              } finally {
                checkinBtn.disabled = false;
              }
            };
          } else {
            checkinBox.classList.add('hidden');
          }
        }
      } catch (error) {
        console.error("Error in initDashboard:", error);
        if (historyListEl) historyListEl.innerHTML = `<li class="text-center text-red-500 py-4">เกิดข้อผิดพลาดในการโหลดข้อมูล</li>`;
        if (checkinBox) checkinBox.classList.add('hidden');
      }
    }

    async function initEvent() { /* ... same as before ... */ }
    async function initEventDetail() { /* ... same as before ... */ }

    // ปรับปรุง initProfile
    async function initProfile() {
      const profileDisplayPictureEl = document.getElementById('profileDisplayPicture');
      const profileDisplayNameEl = document.getElementById('profileDisplayName');
      const profileLineIdEl = document.getElementById('profileLineId');
      
      const profileLevelTextDisplayEl = document.getElementById('profileLevelTextDisplay');
      const profileLevelBadgeEl = document.getElementById('profileLevelBadge');
      const profileCustomTagBadgeEl = document.getElementById('profileCustomTagBadge'); // NEW: for the profile custom tag badge
      
      const profileProgressBarEl = document.getElementById('profileProgressBar');
      const profilePointsToNextLevelEl = document.getElementById('profilePointsToNextLevel');
      const profileTotalPointsEl = document.getElementById('profileTotalPoints');

      const profileNameEl = document.getElementById('profileName');
      const profilePhoneEl = document.getElementById('profilePhone');
      const profileEmailEl = document.getElementById('profileEmail');
      const profileAddressEl = document.getElementById('profileAddress');
      const profileNoteEl = document.getElementById('profileNote');
      const updateBtn = document.getElementById('updateProfileBtn');

      if (profileDisplayPictureEl && userState.profile) {
        profileDisplayPictureEl.src = userState.profile.pictureUrl || 'https://upload.wikimedia.org/wikipedia/commons/thumb/1/18/Line-icon.svg/1200px-Line-icon.svg.png';
      }
      if (profileDisplayNameEl && userState.profile) {
        profileDisplayNameEl.textContent = userState.profile.displayName || 'ผู้ใช้ LINE';
      }
      if (profileLineIdEl && userState.lineId) {
        profileLineIdEl.value = userState.lineId;
      }
      if (profileTotalPointsEl) {
        profileTotalPointsEl.textContent = userState.points.toLocaleString();
      }

      // แสดงระดับและ Progress Bar ในหน้า Profile
      const { level, progressValue, pointsToNext, nextLevelName } = calculateLevelAndProgress(userState.points);
      
      // Update level text and badge in profile
      if (profileLevelTextDisplayEl) {
        profileLevelTextDisplayEl.textContent = LEVEL_STYLES[level] ? LEVEL_STYLES[level].text : level;
      }
      setBadgeContent(profileLevelBadgeEl, LEVEL_STYLES[level] ? LEVEL_STYLES[level].text : level, `badge badge-lg ${LEVEL_STYLES[level] ? LEVEL_STYLES[level].class : ''}`);
      
      // NEW: Update custom tag badge in profile
      const customTagInfo = CUSTOM_TAG_STYLES[userState.customTag.toLowerCase()] || CUSTOM_TAG_STYLES['default'];
      const tagText = userState.customTag || customTagInfo.text;
      setBadgeContent(profileCustomTagBadgeEl, tagText, `badge badge-lg ${customTagInfo.class}`);
      if (!userState.customTag) profileCustomTagBadgeEl.classList.add('hidden'); // Ensure hidden if no tag

      if (profileProgressBarEl) profileProgressBarEl.value = progressValue;
      if (profilePointsToNextLevelEl) {
        if (nextLevelName) {
          profilePointsToNextLevelEl.textContent = `อีก ${pointsToNext} พ้อยต์ สู่ระดับ ${nextLevelName}`;
        } else {
          profilePointsToNextLevelEl.textContent = `คุณอยู่ในระดับสูงสุดแล้ว!`;
        }
      }

      let uData;
      if (dataCache.userProfileFull) {
        uData = dataCache.userProfileFull;
      } else {
        try {
          const uRes = await fetch(`${CONFIG.GAS_URL}?action=getUserInfo&lineId=${userState.lineId}`);
          uData = await uRes.json();
          dataCache.userProfileFull = uData;
        } catch (error) {
          console.error("Error in initProfile:", error);
          showAlert('เกิดข้อผิดพลาด', 'ไม่สามารถโหลดข้อมูลโปรไฟล์ได้');
          if (profileLineIdEl) profileLineIdEl.value = 'โหลดข้อมูลล้มเหลว';
          if (updateBtn) { updateBtn.disabled = true; }
          return;
        }
      }
      
      // อัปเดตฟิลด์ข้อมูลที่สามารถแก้ไขได้
      if (profileNameEl) profileNameEl.value = uData.name || '';
      if (profilePhoneEl) profilePhoneEl.value = uData.phone || '';
      if (profileEmailEl) profileEmailEl.value = uData.email || '';
      if (profileAddressEl) profileAddressEl.value = uData.address || '';
      if (profileNoteEl) profileNoteEl.value = uData.note || '';

      if (updateBtn) {
        updateBtn.onclick = async () => {
          updateBtn.disabled = true;
          try {
            const body = {
              action: 'updateProfile',
              lineId: userState.lineId,
              name: profileNameEl.value,
              phone: profilePhoneEl.value,
              email: profileEmailEl.value,
              address: profileAddressEl.value,
              note: profileNoteEl.value
            };
            const res = await fetch(CONFIG.GAS_URL, {
              method: 'POST',
              body: JSON.stringify(body)
            });
            const responseText = await res.text();
            showAlert("สถานะ", responseText, () => {
                if (responseText.includes("สำเร็จ")) {
                    dataCache.userProfileFull = { 
                        ...dataCache.userProfileFull, 
                        name: profileNameEl.value,
                        phone: profilePhoneEl.value,
                        email: profileEmailEl.value,
                        address: profileAddressEl.value,
                        note: profileNoteEl.value
                    };
                }
            });
          } catch (e) {
            console.error("Update profile failed:", e);
            showAlert('ข้อผิดพลาด', 'ไม่สามารถอัปเดตข้อมูลได้ กรุณาลองใหม่');
          } finally {
            updateBtn.disabled = false;
          }
        };
      }
    }

    async function initRedeem() { /* ... same as before ... */ }
    async function initTransfer() { /* ... same as before ... */ }
    async function initWarehouse() { /* ... same as before ... */ }
    async function initAddpoint() { /* ... same as before ... */ }


    // --- Global App Initialization ---
    async function initializeApp() {
      const liffReady = await ensureLIFFAndFetchInitialData();
      if (!liffReady) { return; }
      window.addEventListener('hashchange', router);
      router();
    }

    initializeApp();
  </script>
</body>

</html>
