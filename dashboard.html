<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    /* ฟอนต์ Kanit */
    @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Kanit', sans-serif; }
  </style>
</head>
<body class="bg-gray-50 p-4">

  <!-- แต้ม -->
  <div class="flex justify-between items-center mb-6">
    <div>
      <p class="text-md font-semibold text-gray-800">อัพเกรด member</p>
      <p class="text-sm text-gray-500">ปลดล็อกสิทธิประโยชน์</p>
    </div>
    <div class="bg-gray-100 rounded-full flex items-center p-1 space-x-2">
      <div class="w-8 h-8 bg-yellow-400 rounded-full pulse"></div>
      <div class="font-bold text-gray-800 text-lg px-2 blink"><span id="point">0</span>+</div>
      <img id="lineDisplayPicture"
           src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/18/Line-icon.svg/1200px-Line-icon.svg.png"
           alt="LINE DP"
           class="w-10 h-10 rounded-full object-cover border-2 border-purple-900">
    </div>
  </div>

  <!-- เมนู -->
  <div class="bg-purple-900 rounded-2xl p-4 grid grid-cols-3 gap-3 text-center text-sm font-medium mb-6">
    <!-- ... (ลิงก์เมนูตามตัวอย่างเดิม) ... -->
  </div>

  <!-- เช็คอิน -->
  <div id="checkinBox" class="flex items-center justify-between mb-8 hidden">
    <div class="bg-gray-100 rounded-full px-4 py-2 flex items-center space-x-2 text-gray-700">
      <span class="text-sm">วันที่</span>
      <span id="todayDate" class="font-bold text-md">00</span>
    </div>
    <div class="bg-yellow-400 rounded-full w-10 h-10 flex items-center justify-center text-white font-bold text-sm">
      +1
    </div>
    <button onclick="checkin()"
            class="bg-purple-900 text-white px-8 py-3 rounded-full text-sm font-semibold transform hover:scale-105 transition-transform">
      เช็คอิน
    </button>
  </div>

  <!-- ประวัติ -->
  <div>
    <div class="flex justify-between items-center mb-4">
      <div class="font-bold text-lg">รายการล่าสุด</div>
      <div class="text-xs text-gray-400 font-medium">POINT</div>
    </div>
    <ul id="historyList" class="space-y-4">
      <!-- Skeleton loader เริ่มต้น -->
      <li class="flex justify-between items-center animate-pulse">
        <div class="space-y-2 flex-1">
          <div class="h-4 bg-gray-200 rounded w-3/5"></div>
          <div class="h-3 bg-gray-200 rounded w-2/5"></div>
        </div>
        <div class="h-6 w-12 bg-gray-200 rounded-full"></div>
      </li>
      <li class="flex justify-between items-center animate-pulse">
        <div class="space-y-2 flex-1">
          <div class="h-4 bg-gray-200 rounded w-2/3"></div>
          <div class="h-3 bg-gray-200 rounded w-1/2"></div>
        </div>
        <div class="h-6 w-12 bg-gray-200 rounded-full"></div>
      </li>
      <!-- สามารถเพิ่ม skeleton ได้ตามต้องการ -->
    </ul>
  </div>

  <!-- Custom Animations -->
  <style>
    @keyframes blink {
      0%,100% { opacity: 1; }
      50%      { opacity: 0.4; }
    }
    .blink { animation: blink 1.2s ease-in-out infinite; }

    @keyframes pulseCustom {
      0%   { transform: scale(1); opacity: 1; }
      50%  { transform: scale(1.05); opacity: 0.6; }
      100% { transform: scale(1); opacity: 1; }
    }
    .pulse { animation: pulseCustom 1.2s ease-in-out infinite; }
  </style>

  <script>
    let lineId = "";

    // สร้าง skeleton ตามจำนวน count
    function generateSkeleton(count) {
      return Array.from({length: count}).map(_=>`
        <li class="flex justify-between items-center animate-pulse">
          <div class="space-y-2 flex-1">
            <div class="h-4 bg-gray-200 rounded w-${Math.floor(30 + Math.random()*40)}%"></div>
            <div class="h-3 bg-gray-200 rounded w-${Math.floor(30 + Math.random()*30)}%"></div>
          </div>
          <div class="h-6 w-12 bg-gray-200 rounded-full"></div>
        </li>
      `).join("");
    }

    async function init() {
      await liff.init({ liffId: "2007514355-N7ZqG4BK" });
      if (!liff.isLoggedIn()) { liff.login(); return; }

      const profile = await liff.getProfile();
      lineId = profile.userId;
      // โปรไฟล์
      const dp = document.getElementById('lineDisplayPicture');
      if (profile.pictureUrl) {
        dp.src = profile.pictureUrl;
        dp.alt = `รูปของ ${profile.displayName}`;
      }

      // แต้ม
      const user = await fetch(`https://script.google.com/macros/s/AKfycbwzjlrbM1XmUhpUg1nWCij7-0wq1CRhixz-uA9cwv58qMK5Hp1xq03XZDeVnAR6C3WheA/exec?action=getUserInfo&lineId=${lineId}`);
      const userData = await user.json();
      document.getElementById("point").textContent = userData.point || 0;

      // เช็คอิน
      const check = await fetch(`https://script.google.com/macros/s/AKfycbwzjlrbM1XmUhpUg1nWCij7-0wq1CRhixz-uA9cwv58qMK5Hp1xq03XZDeVnAR6C3WheA/exec?action=checkinStatus&lineId=${lineId}`);
      const c = await check.json();
      if (!c.checkedInToday) document.getElementById("checkinBox").classList.remove("hidden");
      document.getElementById("todayDate").textContent = new Date().getDate().toString().padStart(2,"0");

      // ประวัติ — แสดง skeleton ก่อน
      const historyList = document.getElementById("historyList");
      historyList.innerHTML = generateSkeleton(6);

      const hist = await fetch(`https://script.google.com/macros/s/AKfycbwzjlrbM1XmUhpUg1nWCij7-0wq1CRhixz-uA9cwv58qMK5Hp1xq03XZDeVnAR6C3WheA/exec?action=getHistory&lineId=${lineId}`);
      const list = await hist.json();

      if (list.length === 0) {
        historyList.innerHTML = `<li class="text-center text-gray-500 py-4">ไม่มีประวัติการทำรายการ</li>`;
        return;
      }

      const latest10 = list.reverse().slice(0,10);
      historyList.innerHTML = latest10.map(item=>{
        const isDebit = ['redeem','transfer_out'].includes(item.type);
        const badge = isDebit ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700';
        const sign  = isDebit ? '-' : '+';
        return `
          <li class="flex justify-between items-center">
            <div>
              <div class="font-medium text-gray-800 text-sm">${item.detail}</div>
              <div class="text-xs text-gray-400 mt-1">${item.date}</div>
            </div>
            <div class="text-sm font-bold px-4 py-1.5 rounded-full ${badge}">
              ${sign} ${item.amount}
            </div>
          </li>`;
      }).join("");
    }

    async function checkin() {
      await fetch("https://script.google.com/macros/s/AKfycbwzjlrbM1XmUhpUg1nWCij7-0wq1CRhixz-uA9cwv58qMK5Hp1xq03XZDeVnAR6C3WheA/exec", {
        method: "POST",
        body: JSON.stringify({ action: "dailyCheckin", lineId })
      });
      location.reload();
    }

    init();
  </script>
</body>
</html>
